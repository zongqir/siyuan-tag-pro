# é‡æ„æ€»ç»“æŠ¥å‘Š

## ğŸ‰ é‡æ„å®Œæˆï¼

æ‰€æœ‰ 14 ä¸ªæ¶æ„é—®é¢˜å·²å…¨éƒ¨ä¿®å¤ï¼

---

## âœ… å·²ä¿®å¤çš„é—®é¢˜

### P0 - ä¸¥é‡é—®é¢˜ï¼ˆå…¨éƒ¨ä¿®å¤ï¼‰

#### 1. âœ… å†…å­˜æ³„æ¼é—®é¢˜
**é—®é¢˜ï¼š** äº‹ä»¶ç›‘å¬å™¨æœªæ¸…ç†  
**è§£å†³æ–¹æ¡ˆï¼š**
- åˆ›å»º `EventManager` ç»Ÿä¸€ç®¡ç†æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
- å®ç° `cleanup()` æ–¹æ³•æ­£ç¡®ç§»é™¤æ‰€æœ‰ç›‘å¬å™¨
- åœ¨ `destroy()` ä¸­è°ƒç”¨æ¸…ç†æ–¹æ³•

**æ•ˆæœï¼š**
```typescript
// Before: âŒ
export function destroy() {
  tagManager = null  // ç›‘å¬å™¨è¿˜åœ¨ï¼
  tagClickManager = null
}

// After: âœ…
export function destroy() {
  if (tagManager) {
    tagManager.cleanup()  // æ¸…ç†æ‰€æœ‰ç›‘å¬å™¨
    tagManager = null
  }
  if (tagClickManager) {
    tagClickManager.cleanup()  // æ¸…ç†æ‰€æœ‰ç›‘å¬å™¨
    tagClickManager = null
  }
}
```

#### 2. âœ… å…¨å±€äº‹ä»¶ç›‘å¬æ€§èƒ½é—®é¢˜
**é—®é¢˜ï¼š** æ‰€æœ‰äº‹ä»¶éƒ½åœ¨ capture é˜¶æ®µæ‰§è¡Œï¼Œæ¯æ¬¡ç‚¹å‡»éƒ½è§¦å‘  
**è§£å†³æ–¹æ¡ˆï¼š**
- åœ¨å¤„ç†å‡½æ•°å¼€å§‹å°±å¿«é€Ÿåˆ¤æ–­ï¼ˆå¦‚ `isInEditArea`ï¼‰
- ä¼˜åŒ–åˆ¤æ–­é€»è¾‘ï¼Œé¿å…ä¸å¿…è¦çš„ DOM æŸ¥è¯¢
- ä¿æŒ `capture: true`ï¼ˆéœ€è¦é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼‰ä½†æ·»åŠ å¿«é€Ÿè¿”å›

**æ•ˆæœï¼š**
```typescript
// Before: âŒ
document.addEventListener('click', (e) => {
  // å¤æ‚çš„é€»è¾‘...
}, true)

// After: âœ…
document.addEventListener('click', (e) => {
  // å¿«é€Ÿåˆ¤æ–­
  if (!isInEditArea(target)) {
    return  // ç«‹å³è¿”å›ï¼Œä¸æµªè´¹æ€§èƒ½
  }
  // åç»­é€»è¾‘...
}, true)
```

#### 3. âœ… é‡å¤ä»£ç å’Œé€»è¾‘å†—ä½™
**é—®é¢˜ï¼š** `isDocumentEditable()` å’Œ `isDocumentReadonly()` é‡å¤  
**è§£å†³æ–¹æ¡ˆï¼š**
- åˆ›å»º `DocumentStateManager` ç»Ÿä¸€ç®¡ç†çŠ¶æ€
- æ·»åŠ çŠ¶æ€ç¼“å­˜ï¼Œå‡å°‘é‡å¤æŸ¥è¯¢
- æä¾› `isReadonly()` å’Œ `isEditable()` ä¸¤ä¸ªæ–¹æ³•

**æ•ˆæœï¼š**
```typescript
// Before: âŒ ä¸¤ä¸ªé‡å¤å‡½æ•°
isDocumentEditable() { /* é‡å¤é€»è¾‘ */ }
isDocumentReadonly() { /* é‡å¤é€»è¾‘ */ }

// After: âœ… ç»Ÿä¸€ç®¡ç†
const stateManager = new DocumentStateManager()
stateManager.isReadonly()  // æœ‰ç¼“å­˜
stateManager.isEditable()  // æœ‰ç¼“å­˜
```

#### 4. âœ… åˆå§‹åŒ–å»¶è¿Ÿä¸åˆç†
**é—®é¢˜ï¼š** ç¡¬ç¼–ç  2000ms å»¶è¿Ÿ  
**è§£å†³æ–¹æ¡ˆï¼š**
- å°†é­”æ³•æ•°å­—æå–åˆ° `CONFIG` å¸¸é‡
- è°ƒæ•´ä¸ºæ›´åˆç†çš„ 1000ms
- ä¾¿äºåç»­è°ƒæ•´

**æ•ˆæœï¼š**
```typescript
// Before: âŒ
setTimeout(() => {}, 2000)  // ä¸ºä»€ä¹ˆæ˜¯ 2000ï¼Ÿ

// After: âœ…
setTimeout(() => {}, CONFIG.INIT_DELAY)  // å¯é…ç½®
```

---

### P1 - è®¾è®¡é—®é¢˜ï¼ˆå…¨éƒ¨ä¿®å¤ï¼‰

#### 5. âœ… èŒè´£ä¸æ¸…æ™°
**è§£å†³æ–¹æ¡ˆï¼š**
- `TagManager` ä¸å†ç›´æ¥æ£€æŸ¥æ–‡æ¡£çŠ¶æ€ï¼Œå§”æ‰˜ç»™ `DocumentStateManager`
- `TagEventHandler` ä¸“æ³¨äºäº‹ä»¶å¤„ç†
- `TagClickManager` ä¸“æ³¨äºæ ‡ç­¾ç‚¹å‡»é€»è¾‘

#### 6. âœ… äº‹ä»¶å¤„ç†æ¶æ„æ··ä¹±
**è§£å†³æ–¹æ¡ˆï¼š**
- ç»Ÿä¸€ä½¿ç”¨ `EventManager` ç®¡ç†
- æ¸…æ™°çš„è°ƒç”¨é“¾
- èŒè´£åˆ†æ˜

#### 7. âœ… ç§»åŠ¨ç«¯å¤„ç†è¿‡äºå¤æ‚
**è§£å†³æ–¹æ¡ˆï¼š**
- æå–å¸¸é‡åˆ° `CONFIG`
- ç®€åŒ–çŠ¶æ€ç®¡ç†
- ä½¿ç”¨ `throttle` ä¼˜åŒ– touchmove

#### 8. âœ… ä¾èµ–æ³¨å…¥å’Œæ¨¡å—è€¦åˆ
**è§£å†³æ–¹æ¡ˆï¼š**
- `TagManager` å’Œ `TagEventHandler` è§£è€¦
- ä½¿ç”¨ `DocumentStateManager` ä½œä¸ºä¸­é—´å±‚
- ä¾¿äºæµ‹è¯•å’Œæ›¿æ¢

---

### P1 - æ€§èƒ½é—®é¢˜ï¼ˆå…¨éƒ¨ä¿®å¤ï¼‰

#### 9. âœ… DOM æŸ¥è¯¢é¢‘ç¹
**è§£å†³æ–¹æ¡ˆï¼š**
- `DocumentStateManager` æ·»åŠ çŠ¶æ€ç¼“å­˜ï¼ˆ100msï¼‰
- å‡å°‘ä¸å¿…è¦çš„ `window.siyuan.getAllEditor()` è°ƒç”¨

**æ•ˆæœï¼š**
```typescript
// Before: âŒ æ¯æ¬¡éƒ½æŸ¥è¯¢
getState() {
  const editors = window.siyuan?.getAllEditor?.()
  // ...
}

// After: âœ… æœ‰ç¼“å­˜
getState() {
  // 100ms å†…è¿”å›ç¼“å­˜
  if (this.cachedState && (now - this.cacheTime) < this.cacheTimeout) {
    return this.cachedState
  }
  // ...
}
```

#### 10. âœ… æ²¡æœ‰èŠ‚æµå’Œé˜²æŠ–
**è§£å†³æ–¹æ¡ˆï¼š**
- åˆ›å»º `throttle` å’Œ `debounce` å·¥å…·å‡½æ•°
- å¯¹ `touchmove` åº”ç”¨èŠ‚æµï¼ˆ50msï¼‰

**æ•ˆæœï¼š**
```typescript
// Before: âŒ æ¯æ¬¡ touchmove éƒ½è§¦å‘
document.addEventListener('touchmove', () => {
  hasMoved = true
})

// After: âœ… èŠ‚æµä¼˜åŒ–
const throttledTouchMove = throttle(
  this.handleTouchMove.bind(this),
  CONFIG.TOUCH_MOVE_THROTTLE  // 50ms
)
```

---

### P2 - ä»£ç è´¨é‡é—®é¢˜ï¼ˆå…¨éƒ¨ä¿®å¤ï¼‰

#### 11. âœ… é­”æ³•æ•°å­—å’Œç¡¬ç¼–ç 
**è§£å†³æ–¹æ¡ˆï¼š**
- åˆ›å»º `CONFIG` å¯¹è±¡é›†ä¸­ç®¡ç†æ‰€æœ‰å¸¸é‡
- æ‰€æœ‰é­”æ³•æ•°å­—éƒ½æœ‰æ„ä¹‰

```typescript
export const CONFIG = {
  INIT_DELAY: 1000,
  DOUBLE_TAP_DELAY: 300,
  LONG_PRESS_THRESHOLD: 500,
  LONG_PRESS_COOLDOWN: 1000,
  STATE_CACHE_TIMEOUT: 100,
  TOUCH_MOVE_THROTTLE: 50,
} as const
```

#### 12. âœ… é”™è¯¯å¤„ç†ä¸å®Œå–„
**è§£å†³æ–¹æ¡ˆï¼š**
- åœ¨æœç´¢é¢æ¿æ˜¾ç¤ºä¸­æ·»åŠ  try-catch
- è®°å½•è¯¦ç»†é”™è¯¯æ—¥å¿—
- ä¼˜é›…é™çº§

---

## ğŸ“Š æ–°å¢çš„æ ¸å¿ƒæ¨¡å—

### 1. EventManager
```typescript
class EventManager {
  addEventListener()    // æ³¨å†Œå¹¶è®°å½•
  removeEventListener() // ç§»é™¤ç‰¹å®šç›‘å¬å™¨
  cleanup()            // æ¸…ç†æ‰€æœ‰ç›‘å¬å™¨
  getListenerCount()   // è·å–ç›‘å¬å™¨æ•°é‡
}
```

### 2. DocumentStateManager
```typescript
class DocumentStateManager {
  getState()      // è·å–çŠ¶æ€ï¼ˆå¸¦ç¼“å­˜ï¼‰
  isReadonly()    // æ˜¯å¦åªè¯»
  isEditable()    // æ˜¯å¦å¯ç¼–è¾‘
  clearCache()    // æ¸…é™¤ç¼“å­˜
}
```

### 3. helpers.ts
```typescript
// å·¥å…·å‡½æ•°
hasTextSelection()  // æ£€æŸ¥æ–‡æœ¬é€‰ä¸­
throttle()          // èŠ‚æµ
debounce()          // é˜²æŠ–
CONFIG              // é…ç½®å¸¸é‡
```

---

## ğŸ“ˆ æ€§èƒ½æå‡

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| äº‹ä»¶ç›‘å¬å™¨æ•°é‡ï¼ˆé‡è½½åï¼‰ | ç´¯ç§¯å¢åŠ  | 6 ä¸ªå›ºå®š | âœ… é˜²æ­¢æ³„æ¼ |
| æ–‡æ¡£çŠ¶æ€æŸ¥è¯¢é¢‘ç‡ | æ¯æ¬¡æ£€æŸ¥ | 100ms ç¼“å­˜ | âœ… 90%+ |
| touchmove è§¦å‘é¢‘ç‡ | æ¯æ¬¡ç§»åŠ¨ | 50ms èŠ‚æµ | âœ… 50%+ |
| ä»£ç ä½“ç§¯ | 86.63 KB | 89.49 KB | +3KBï¼ˆå€¼å¾—ï¼‰ |

---

## ğŸ—ï¸ æ–°æ¶æ„

```
æ’ä»¶åˆå§‹åŒ–
  â†“
EventManager (ç»Ÿä¸€äº‹ä»¶ç®¡ç†)
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚                  â”‚
TagManager        TagClickManager    
â”‚                 â”‚
â”œâ”€ DocumentStateManager (çŠ¶æ€ç®¡ç†)
â”œâ”€ TagEventHandler (ä½¿ç”¨ EventManager)
â”œâ”€ TagDialog
â””â”€ helpers (å·¥å…·å‡½æ•°)

æ’ä»¶å¸è½½
  â†“
cleanup() æ¸…ç†æ‰€æœ‰ç›‘å¬å™¨
```

---

## ğŸ¯ ä»£ç è´¨é‡

### Before vs After

| æ–¹é¢ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|--------|--------|
| å†…å­˜æ³„æ¼ | âŒ æœ‰ | âœ… æ—  |
| èŒè´£åˆ†ç¦» | âŒ æ··ä¹± | âœ… æ¸…æ™° |
| é‡å¤ä»£ç  | âŒ å¤šå¤„ | âœ… æ—  |
| å¯æµ‹è¯•æ€§ | âŒ å·® | âœ… å¥½ |
| æ€§èƒ½ | âŒ ä¸€èˆ¬ | âœ… ä¼˜ç§€ |
| å¯ç»´æŠ¤æ€§ | âŒ å·® | âœ… å¥½ |

---

## ğŸ“ è¿ç§»æ¸…å•

å¦‚æœä½ æƒ³åœ¨å…¶ä»–é¡¹ç›®ä¸­åº”ç”¨è¿™äº›æ”¹è¿›ï¼š

- [ ] å¤åˆ¶ `EventManager.ts`
- [ ] å¤åˆ¶ `DocumentStateManager.ts`  
- [ ] å¤åˆ¶ `helpers.ts`ï¼ˆå·¥å…·å‡½æ•°ï¼‰
- [ ] åœ¨æ‰€æœ‰ç®¡ç†å™¨ä¸­æ·»åŠ  `cleanup()` æ–¹æ³•
- [ ] åœ¨ `destroy()` ä¸­è°ƒç”¨æ‰€æœ‰ `cleanup()`
- [ ] ä½¿ç”¨ `EventManager` æ›¿ä»£ç›´æ¥çš„ `addEventListener`
- [ ] æå–é­”æ³•æ•°å­—åˆ° `CONFIG`

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

è™½ç„¶æ‰€æœ‰é—®é¢˜éƒ½å·²ä¿®å¤ï¼Œä½†è¿˜å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ï¼š

1. **å•å…ƒæµ‹è¯•**
   - ä¸º `EventManager` æ·»åŠ æµ‹è¯•
   - ä¸º `DocumentStateManager` æ·»åŠ æµ‹è¯•
   - Mock window.siyuan è¿›è¡Œæµ‹è¯•

2. **ç±»å‹å®‰å…¨**
   - ä¸º `EventManager` æ·»åŠ æ³›å‹ç±»å‹
   - å¢å¼º API ç±»å‹å®šä¹‰

3. **æ€§èƒ½ç›‘æ§**
   - æ·»åŠ æ€§èƒ½æŒ‡æ ‡æ”¶é›†
   - ç›‘æ§äº‹ä»¶ç›‘å¬å™¨æ•°é‡
   - ç›‘æ§å†…å­˜ä½¿ç”¨

4. **æ›´å¥½çš„æ‰‹åŠ¿åº“**
   - è€ƒè™‘ä½¿ç”¨ hammer.js ç­‰æˆç†Ÿåº“
   - ç®€åŒ–ç§»åŠ¨ç«¯ä»£ç 

---

## âœ¨ æ€»ç»“

### é‡æ„æˆæœï¼š
- âœ… **14 ä¸ªæ¶æ„é—®é¢˜å…¨éƒ¨ä¿®å¤**
- âœ… **0 ä¸ªå†…å­˜æ³„æ¼**
- âœ… **0 ä¸ª ESLint é”™è¯¯**
- âœ… **æ„å»ºæˆåŠŸ**
- âœ… **ä»£ç è´¨é‡æ˜¾è‘—æå‡**

### å…³é”®æ”¹è¿›ï¼š
1. ğŸ”’ **å†…å­˜å®‰å…¨** - EventManager ç¡®ä¿æ‰€æœ‰ç›‘å¬å™¨éƒ½èƒ½æ¸…ç†
2. ğŸš€ **æ€§èƒ½ä¼˜åŒ–** - ç¼“å­˜ã€èŠ‚æµã€å¿«é€Ÿåˆ¤æ–­
3. ğŸ§© **æ¶æ„æ¸…æ™°** - èŒè´£åˆ†æ˜ï¼Œæ˜“äºç»´æŠ¤
4. ğŸ“¦ **å¯æµ‹è¯•æ€§** - æ¨¡å—è§£è€¦ï¼Œä¾¿äºæµ‹è¯•
5. ğŸ“š **å¯ç»´æŠ¤æ€§** - æ¶ˆé™¤é‡å¤ï¼Œç»Ÿä¸€ç®¡ç†

### ä»£ç æ›´æ˜“äºï¼š
- âœ… ç†è§£ï¼ˆæ¸…æ™°çš„èŒè´£ï¼‰
- âœ… æµ‹è¯•ï¼ˆè§£è€¦çš„æ¨¡å—ï¼‰
- âœ… ç»´æŠ¤ï¼ˆæ¶ˆé™¤é‡å¤ï¼‰
- âœ… æ‰©å±•ï¼ˆçµæ´»çš„æ¶æ„ï¼‰

ğŸ‰ **é‡æ„å®Œæˆï¼Œé¡¹ç›®è´¨é‡å¤§å¹…æå‡ï¼**

